#!/usr/bin/env node

const { cpSync, existsSync, unlinkSync } = require("fs");
const { resolve } = require("path");
const { exec, execSync } = require("child_process");

// The list of valid environments.
const environments = ["dev", "test", "prod"];

// Retrieve the chosen environment passed via the command line.
const cliArgs = process.argv.slice(2);
const chosenEnvironment = cliArgs[0];

// Throw an error if the chosen environment is invalid.
if (!environments.includes(chosenEnvironment)) {
  throw new Error(
    `${chosenEnvironment} is not a valid environment. Valid environments include dev, test, and prod.`
  );
}

// Copy the relevent environment file into the root, overwriting the existing .env if it exists.
const rootDirectory = resolve(__dirname, "..");
const environmentFileSourcePath = resolve(
  rootDirectory,
  `config/env/.env.${chosenEnvironment}`
);
const environmentFileDestPath = resolve(rootDirectory, ".env");
cpSync(environmentFileSourcePath, environmentFileDestPath);

const localProdEnvironmentPath = resolve(rootDirectory, ".env.prod.local");

// If the 'prod' environment was chosen, decrypt the secrets. Otherwise if an old one exists delete it.
if (chosenEnvironment == "prod") {
  execSync(`APP_ENV='prod' php bin/console secrets:decrypt-to-local --force`);
} else if (existsSync(localProdEnvironmentPath)) {
  unlinkSync(localProdEnvironmentPath);
}
